<!-- omit in toc -->
# Dynamic Analysis

<!-- omit in toc -->
## Table of Contents

1. [Notes](#notes)
2. [Program Execution Flow](#program-execution-flow)
   1. [Tools](#tools)
      1. [Procmon](#procmon)
         1. [Features](#features)
         2. [Filter](#filter)
         3. [Process Tree](#process-tree)
      2. [Debuggers](#debuggers)
         1. [x32dbg](#x32dbg)
            1. [Tabs](#tabs)
            2. [Shortcuts](#shortcuts)
   2. [Tips](#tips)
3. [Network](#network)
   1. [Capture Procedure](#capture-procedure)
   2. [Protocols](#protocols)
      1. [DNS](#dns)
   3. [Tools](#tools-1)
      1. [TCPView](#tcpview)
      2. [Wireshark](#wireshark)

## Notes

- Always correlate data with Static Analysis.

## Program Execution Flow

### Tools

#### Procmon

##### Features

- Registry activity.
- Filesystem activity.
- Process activity.
- Network activity.

##### Filter

- Process Name: Filter by the name of a process (Same as the name of the executable).
- PID: Filter by the Process ID of a binary.
- Parent PID: Filter by the Parent Process ID of a binary.
- Operation: Filter by names of performed operations. For example, `File` to get all the operations related to file operations.
- Detail: Filter by details of the operations. For example, commands executed with `cmd.exe` will appear in details.
- Path: Filter by path.

##### Process Tree

- View the father/child processes in a tree representation.
- Parent process is usually `Explorer.exe`.
- Attackers de-parent (detached process from parent) processes to obfuscate the analysis.

#### Debuggers

##### x32dbg

###### Tabs

TODO:

- CPU:
  - Disassembly: Displays the disassembled code.
  - Register values: Displays the register values in runtime. Values can be changed in execution, for example to meet conditions.
  - Watch: Displays the watch.
  - Hex dump: Displays the raw hex.
  - Stack: Displays the stack in runtime.
- Log:
- Notes:
- Breakpoints: Displays all the set breakpoints. Create, change, delete them.
- Memory map:
- Call stack:
- SEH:
- Script:
- Symbols:
- Source:
- References:
- Threads:
- Handles:
- Trace:

###### Shortcuts

- F9: Run.
- F4: Run until selection.
- F7: Step into.
- F8: Step over.
- F2: Set breakpoint.
- Ctrl + F2: Restart.

### Tips

- Check the process start as it can reveal the command being used to launch it.
- Check the high-level steps followed by the binary at execution time.
- Always analyze what happens if the binary is in a sandbox environment (No Internet).

## Network

### Capture Procedure

- Start `inetsim` in REMnux machine.
- Connect FlareVM to the REMnux machine network (Use REMnux IP as DNS server).
- Open `Wireshark` in REMnux machine and start capturing.
- Filter for HTTP, DNS... traffic.
- Follow streams (Always start with high layer protocols).
- Extract C2 servers and URLs.

### Protocols

#### DNS

- We have to see DNS traffic in `Wireshark`.
- Extract the domain that is being queried.
- Add the domain to the hosts file in FlareVM pointing to localhost.
  - Edit `C:\Windows\System32\drivers\etc\hosts`.
  - `ipconfig /flushdns`.
- Search for TCP operations of the binary in `procmon`.
  - This will reveal useful information in the path field. For example, the protocol or port that is being used.
- Listen in the revealed port for a connection.
- Run the binary and wait for a connection.
- Try different things in order to explore the functionality of the open socket. For example, system commands as `whoami`.

### Tools

#### TCPView

- Analyzes the TCP connections that a binary performs.
- Good practice to correlate with `procmon` operations.

#### Wireshark

- With `inetsim` configured, you can use `Wireshark` to view the traffic a binary generates in execution.  
