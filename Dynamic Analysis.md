<!-- omit in toc -->
# Dynamic Analysis

<!-- omit in toc -->
## Table of Contents

1. [Notes](#notes)
2. [Network Based Indicators](#network-based-indicators)
   1. [Capture Procedure](#capture-procedure)
   2. [Protocols](#protocols)
      1. [DNS](#dns)
3. [Host Based Indicators](#host-based-indicators)
   1. [Tips](#tips)
   2. [Tools](#tools)
      1. [Procmon](#procmon)
         1. [Features](#features)
         2. [Filter](#filter)
         3. [Process Tree](#process-tree)
      2. [TCPView](#tcpview)
4. [Program Execution Flow](#program-execution-flow)

## Notes

- Always correlate data with Static Analysis.

## Network Based Indicators

### Capture Procedure

- Start `inetsim` in REMnux machine.
- Connect FlareVM to the REMnux machine network (Use REMnux IP as DNS server).
- Open `Wireshark` in REMnux machine and start capturing.
- Filter for HTTP, DNS... traffic.
- Follow streams (Always start with high layer protocols).
- Extract C2 servers and URLs.

### Protocols

#### DNS

- We have to see DNS traffic in `Wireshark`.
- Extract the domain that is being queried.
- Add the domain to the hosts file in FlareVM pointing to localhost.
  - Edit `C:\Windows\System32\drivers\etc\hosts`.
  - `ipconfig /flushdns`.
- Search for TCP operations of the binary in `procmon`.
  - This will reveal useful information in the path field. For example, the protocol or port that is being used.
- Listen in the revealed port for a connection.
- Run the binary and wait for a connection.
- Try different things in order to explore the functionality of the open socket. For example, system commands as `whoami`.

## Host Based Indicators

### Tips

- Check the process start as it can reveal the command being used to launch it.

### Tools

#### Procmon

##### Features

- Registry activity.
- Filesystem activity.
- Process activity.
- Network activity.

##### Filter

- Process Name: Filter by the name of a process (Same as the name of the executable).
- PID: Filter by the Process ID of a binary.
- Parent PID: Filter by the Parent Process ID of a binary.
- Operation: Filter by names of performed operations. For example, `File` to get all the operations related to file operations.
- Detail: Filter by details of the operations. For example, commands executed with `cmd.exe` will appear in details.
- Path: Filter by path.

##### Process Tree

- View the father/child processes in a tree representation.
- Parent process is usually `Explorer.exe`.
- Attackers de-parent (detached process from parent) processes to obfuscate the analysis.

#### TCPView

- Analyzes the TCP connections that a binary performs.
- Good practice to correlate with `procmon` operations.

## Program Execution Flow

- Indicates the high-level steps followed by the binary at execution time.
- Always analyze what happens if the binary is in a sandbox environment (No Internet).
