<!-- omit in toc -->
# Evasion Methods

<!-- omit in toc -->
## Table of Contents

1. [Process Injection](#process-injection)
   1. [Common Windows API Functions](#common-windows-api-functions)
   2. [Common Injected Processes](#common-injected-processes)

## Process Injection

- Process Injection allows to execute malicious activity by proxy through processes that either have information of value or that blend in with benign operating system activity.
- In addition to being stealthy, code can inherit the privilege level of the process it is injected into and gain access to parts of the operating system that should not be otherwise available.
- Another added benefit is that allows payloads to be launched within the memory space of a running process without needing to drop any malicious code to disk.

### Common Windows API Functions

- `OpenProcess`: Open an existing local process object.
  - `dwDesiredAccess`: The access to the process object. This access is checked against the security descriptor fot the process.
  - `bInheritHandle`: If this value is true, processes created by this process will inherit the handle. Otherwise, the process do not inherit this handle.
  - `dwProcessId`: The identifier of the local process to be opened.
- `VirtualAllocEx`: Reserves, commits, or changes the state of a region of memory within the virtual address space of a specified process.
  - `hProcess`: The handle to a process.
  - `lpAddress`: The pointer that specifies a desired starting address for the region of pages that you want to allocate.
  - `dwSize`: The size of the region of memory to allocate, in bytes.
  - `flAllocationType`: The type of memory allocation.
  - `flProtect`: The memory protection for the region of pages to be allocated.
- `WriteProcessMemory`: Writes data to an area of memory in a specified process. The entire area to be written to must be accessible or the operation fails.
  - `hProcess`: A handle to the process memory to be modified.
  - `lpBaseAddress`: A pointer to the base address in the specified to which data is written.
  - `lpBuffer`: A pointer to the buffer that contains data to be written in the address space of the specified process.
  - `nSize`: The number of bytes to be written to the specified process.
  - `lpNumberOfBytesWritten`: A pointer to a variable that receives the number of bytes transferred into the specified process. This parameter is optional.
- `CreateRemoteThread`: Creates a thread thar runs in the virtual address space of another process.
  - `hProcess`: A handle to the process in which the thread is to be created.
  - `lpThreadAttributes`: A pointer to a SECURITY_ATTRIBUTES structure that specifies a security descriptor for the new thread and determines whether child processes can inherit the returned handle. If lpThreadAttributes is NULL, the thread gets a default security descriptor and the handle cannot be inherited. The access control lists (ACL) in the default security descriptor for a thread come from the primary token of the creator.
  - `dwStackSize`: The initial size of the stack, in bytes.
  - `lpStartAddress`: A pointer to the application-defined function of type LPTHREAD_START_ROUTINE to be executed by the thread and represents the starting address of the thread in the remote process. The function must exist in the remote process.
  - `lpParameter`: A pointer to a variable to be passed to the thread function.
  - `dwCreationFlags`: The flags that control the creation of the thread.
  - `lpThreadId`: A pointer to a variable that receives the thread identifier. If this parameter is NULL, the thread identifier is not returned.

### Common Injected Processes

- `lsass.exe` (Credential theft).
- `calc.exe` (Evasion).
- `notepad.exe` (Evasion).
- `svchost.exe` (Evasion).
- `backgroundtaskhost.exe** (Application control bypass).
- `dllhost.exe` (Commonly used to host COM components, adversaries often inject into this process in order to blend in to a process that executes often and is expected to have a short lifetime).
- `regsvr32.exe` (Application control bypass and other evasion).
- `searchprotocolhost.exe** (Application control bypass and other evasion).
- `werfault.exe` (Evasion).
- `wuauclt.exe` (Evasion).
- `spoolsv.exe` (Evasion).
- `browser processes` (Normalizing network connections, info stealing/banking trojans)
