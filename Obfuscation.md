<!-- omit in toc -->
# Obfuscation

<!-- omit in toc -->
## Table of Content

- [Links](#links)
- [Goals](#goals)
- [What evasion can and can't do](#what-evasion-can-and-cant-do)
- [Blue kill chain](#blue-kill-chain)
- [How to effectively not be detected](#how-to-effectively-not-be-detected)
- [How does AV and EDR detect malware?](#how-does-av-and-edr-detect-malware)
	- [Static detection methods](#static-detection-methods)

## Links

[Class Resources](https://github.com/BC-SECURITY/Beginners-Guide-to-Obfuscation)

[DevCon presentation](https://www.youtube.com/watch?v=lP2KF7_Kwxk&ab_channel=BCSecurity)

## Goals

- Prevent Reverse Engineering:
  - Protect IP.
  - Hiding what it does.
  - Hide infrastructure (C2, channels, internal pivot points).
- Evade detection by anti-virus and hunters:
  - Disabling security software.
  - Obfuscation.
  - Encryption.
  - Blending into network traffic.
  - Leverage trusted processes.
  - 3rd party communication.

## What evasion can and can't do

- Can:
  - Change indicators of compromise.
  - Extend response time of defenders.
- Can't:
  - Erase all indicators.

## Blue kill chain

- Funnel of fidelity:
  1. Collection.
  2. Detection (10000000s of events).
  3. Triage (100s of alerts).
  4. Investigation (10s of leads).
  5. Remediation (1s of incidents).

## How to effectively not be detected

- How to beat collection.
  - If we can identify the collector, we can potentially disable it.
    - Disable Script Block logging.
    - Turn off NetFlow collection on a router
- How to beat detection:
  - Most of the effort from red team.
  - Blend into the standard traffic.
  - Obfuscation to avoid malicious signatures.
  - Follow normal traffic flows.
    - A random machine logging into a router is probably pretty strange
- How to beat triage:
  - Starting to get a little more scrutiny from defenders
  - Blend into the alerts.
  - Use AV logs to see if anything causes a lot of alerts â–ªAbuse of alert fatigue
  - Abuse assumptions (mini social engineering).
- How to beat investigation:
  - Hands on analysis is beginning to happen
  - At this point an activity has been identified as malicious
  - Prevent them from knowing what is going on:
    - Stomp logs
    - Obfuscate payloads
    - Hide

## How does AV and EDR detect malware?

### Static detection methods

- Hashes:
  - Simply hashing the file and comparing it to a database of known signatures.
  - Extremely fragile, any changes to the file will change the entire signature.
- Byte Matching (String Match):
  - Matching a specific pattern of bytes within the code.
- Hash Scanning:
  - Hybrid of the above two methods.
  - Hash sections of code and look for matches.
- Heuristics:
  - File structure.
  - Logic Flows (Abstract Syntax Trees (AST), Control Flow Graphs (CFG), etc.).
  - Rule based detections (if x & y then malicious):
    - These can also be thought of as context-based detections.
  - Often uses some kind of aggregate risk for probability of malicious file.

TODO:
