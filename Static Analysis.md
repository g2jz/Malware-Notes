<!-- omit in toc -->
# Static Analysis

<!-- omit in toc -->
## Table of Contents

1. [Notes](#notes)
2. [Hashing](#hashing)
   1. [In the Wild](#in-the-wild)
3. [Strings](#strings)
   1. [What can be revealed?](#what-can-be-revealed)
   2. [Tools](#tools)
4. [PE](#pe)
5. [File Structure](#file-structure)
   1. [Interesting Fields](#interesting-fields)
      1. [PEview](#peview)
      2. [PEstudio](#pestudio)
6. [Packing](#packing)
   1. [Features](#features)
   2. [UPX](#upx)
7. [Assembly](#assembly)
   1. [Structure](#structure)
   2. [CPU Instructions](#cpu-instructions)
      1. [Arithmetic](#arithmetic)
      2. [Data Transfer](#data-transfer)
      3. [Control Flow](#control-flow)
         1. [Comparison Instructions](#comparison-instructions)
         2. [Jump Instructions](#jump-instructions)
         3. [Function Calls](#function-calls)
         4. [Others](#others)
      4. [Logical](#logical)
   3. [Tools](#tools-1)
      1. [Cutter](#cutter)

## Notes

- Malware does not need to be armed.

## Hashing

- MD5: `md5sum.exe Malware.exe.malz`.
- SHA1: `sha1sum.exe Malware.exe.malz`.
- SHA256: `sha256sum.exe Malware.exe.malz`.

### In the Wild

- `virustotal.com`: Search > Paste hashes > See if the malware has been seen in the wild.

## Strings

### What can be revealed?

- C2 Servers.
- URLs.
- Function names.

### Tools

- `strings`:
  - `-n`: Minimum string length [3].
  - `-a`: Only ASCII.
  - `-u`: Only Unicode.
  - `-s`: Recurse subdirectories.
- `floss`: Analyze >4 char strings in ASCII and Unicode format.

## PE

## File Structure

1. MZ header [Hex: 4D 5A]: Windows Portable Executable Signature.
2. PE Header:
   1. Image Information.
   2. Section Information.
   3. Directory.
3. Section 1:N.

### Interesting Fields

#### PEview

- Compile Timestamp:
  - IMAGE_NT_HEADERS > IMAGE_FILE_HEADER > Time Date Stamp.
  - Old dates can indicate that AVs might detect it.
  - Borland Delphi compiled executables have a date from 1992.
- Virtual Size:
  - IMAGE_SECTION_HEADER .text > Virtual Size.
  - Indicates the size that the executable uses when loaded on memory.
  - If it is a lot bigger than Size of Raw, it can indicate that the binary is packed.
- Size of Raw:
  - IMAGE_SECTION_HEADER .text > Size of Raw data.
- IAT (Import Address Table):
  - Section .rdata > IMPORT Address Table.
  - [Microsoft Docs](https://learn.microsoft.com/en-us/windows/win32/api/)
  - [MalAPI.io](https://malapi.io/)

#### PEstudio

- General properties:
  - MD5, SHA1 and SHA256 hashes.
  - First bytes (Hex and text).
  - File-size.
  - Entropy.
  - Signature.
  - File-type.
  - CPU.
  - Compiler stamp.
  - Debugger stamp.
- Indicators: It tries to identify malicious activities (Certain strings, functions) and ranks them depending on criticality.
- Libraries: All the DLLs that the binary uses.
  - Flag: A blacklist that identifies the potential malicious libraries.
- Strings: Sort in base to different parameters of strings (Size, offset, encoding).
  - Flag: A blacklist that identifies the potential malicious strings.

## Packing

### Features

- Unpacks the binary in execution time.
- Reduces the size of the binary.
- Obfuscates the contents of the binary.
- AV Evasion.

### UPX

- It changes the section names to `UPX{N}`.
- Few imports in address table.
  - `GetProcAddress` and `LoadLibraryA` used to identify new imports during runtime.
- Big difference between `Size of Raw Data` and `Virtual Size`.

## Assembly

### Structure

- CPU Instructions: Instructions that are being executed in the CPU.
- Memory Registers:
- Stack: Place where information is held in order to access it in a fast way.
  - It grows downwards.

### CPU Instructions

#### Arithmetic

TODO:

- Addition: `add dest,addend`
  - Adds addend to destination and stores the result in destination.
- Subtraction: `sub dest,subtrahend`
  - Subtract subtrahend from destination and stores the result in destination.
- Increment: `inc loc`
  - Increments the register value by 1.
- Decrement: `dec loc`
  - Decrements the value of register/memory by 1.

#### Data Transfer
  
TODO:

- Move: `mov dest,src`
  - Immediate value -> Register. Yes. Into larger register.
  - Immediate value -> Memory. Yes. Up to 32-bit values.
  - Register -> Register. Yes. Same size.
  - Register -> Memory. Yes.
  - Memory -> Register. Yes. Register determines size of retrieved memory.
  - Memory -> Memory. No.
- Push: `push arg`
  - This instruction pushes a value to the stack,specifically, it decrements the stack pointer and stores the data specified as the argument into the location pointed to by the stack pointer.
- Pop: `pop arg`
  - This instruction pops a value from the stack, specifically, it loads the data stored in the location pointed to by the stack pointer into the argument specified and then increments the stack pointer.

#### Control Flow

##### Comparison Instructions

- AND Comparison: `test accumulator,reference`
  - Performs an `AND` without modifying the operands.
  - Modifies the ZF(zero), SF(sign) and PF (parity) flags.
- Subtract comparison: `cmp minuend,subtrahend`
  - Performs a subtraction without modifying the operands.
  - Modifies the ZF(zero), SF(sign) and PF (parity) flags.

##### Jump Instructions

TODO:

- Unconditional Jump: `jmp loc`
  - Loads `EIP` with the specified address.
- Jump if Equal: `je loc`
  - Loads `EIP` with the specified address, if operands of previous `cmp`instructions are equal. `je` is identical to `jz`.
- Jump if Not Equal: `jne loc`
  - Loads `EIP` with the specified address, if the `minuend` of the previous `cmp` instruction is greater than the second (performs signed comparison).
- Jump if Zero: `jz loc`
  - Loads `EIP` with the specified address, if the zero bit is set from a previous arithmetic expression. `jz` is identical to `je`.
- Jump if Not Zero: `jnz loc`
  - Loads `EIP` with the specified address, if the zero bit is not set from a previous arithmetic expression. `jnz` is identical to `jne`.

##### Function Calls

- Call a process: `call proc`
  - Pushes the address of the instruction immediately following the `call` on to the stack. This is done to resume the current function after the invoked function is finished.
  - Jumps to the target address of the called function.
  - In some cases as `shellcode` the call is followed by a `pop` to obtain the current `EIP`.
- Return values: `ret [val]`
  - Pops the return address off the stack and the continues execution at that address.

##### Others

- Do nothing: `nop`
  - This instruction doesn't do anything, but wastes an instruction cycle in the processor.
- Wait: `wait`
  - Wait for the `FPU` to finish its last calculation.

#### Logical

- Logical AND: `and dest,mask`
  - Performs a bit-wise `AND` of the two operands, and stores the result in destination.
- Logical OR: `or dest,addend`
  - Performs a bit-wise `OR` of the two operands, and stores the result in destination.
- Logical XOR: `xor dest,flip`
  - Performs a bit-wise `XOR` of the two operands, and stores the result in destination.
- Logical NOT: `not arg`
  - Performs a bit-wise inversion of argument.

### Tools

#### Cutter

- Assembly decompiler.
- Identifies central function `main`.
- Tabs:
  - Graph: It represents the logical flow with assembly block codes.
  - Decompiler: Tries to reconstruct the assembly into a more readable pseudo-code.
